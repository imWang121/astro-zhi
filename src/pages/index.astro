---
/**
 * Home page component
 * Includes: personal intro, about section, contact links, projects, recent posts, modals
 */
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import HomeStyles from '../styles/HomeStyles.astro';
import ScrollReveal from '../styles/ScrollReveal.astro';
import {
	SITE_DESCRIPTION,
	SITE_TITLE,
	CONTACT_LINKS,
	MODALS,
	HOME_SECTIONS,
	INTRO,
	INTRO_MODE,
	INTRO_IMAGE,
	ABOUT_PARAGRAPHS,
	PROJECTS,
} from '../consts';
import { getCollection } from 'astro:content';

/**
 * Fetch the latest blog posts
 * Sorted by publication date in descending order
 * Count controlled by HOME_SECTIONS.recentPostsCount
 */
const posts = HOME_SECTIONS.recentPosts
	? (await getCollection('blog'))
			.filter((post) => !post.data.draft)
			.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
			.slice(0, HOME_SECTIONS.recentPostsCount)
	: [];
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Header />
		<main>
			<div class="home-container">
				{HOME_SECTIONS.intro && (
					<div class="home-intro scroll-reveal">
						{INTRO_MODE === 'text' ? (
							<>
								{INTRO.greeting && <div class="intro-label">{INTRO.greeting}</div>}
								<h1 class="intro-name">{INTRO.name}</h1>
								<p class="intro-tagline">{INTRO.tagline}</p>
							</>
						) : (
							<div class="intro-image-wrapper">
								<img src={INTRO_IMAGE.src} alt={INTRO_IMAGE.alt} class="intro-image" />
								{INTRO_IMAGE.caption && <p class="intro-caption">{INTRO_IMAGE.caption}</p>}
							</div>
						)}
					</div>
				)}

				{HOME_SECTIONS.about && (
					<div class="home-about scroll-reveal" data-delay="1">
						{ABOUT_PARAGRAPHS.map((paragraph) => (
							<p set:html={paragraph.content} />
						))}
					</div>
				)}

				{HOME_SECTIONS.contact && (
					<div class="home-content scroll-reveal" data-delay="2">
						<div class="contact-header">
							<span class="contact-label-title">如果你想聊聊，随时联系我..</span>
						</div>
						<div class="contact-links">
							{CONTACT_LINKS.filter((link) => link.enabled !== false).map((link) => (
								link.type === 'modal' ? (
									<button class="contact-link yuanbao-btn" id={link.modalId?.replace('Modal', 'Btn')}>
										<span class="contact-icon">
											{link.iconImg && <img src={link.iconImg} alt={link.label} class="yuanbao-icon-img" />}
											{link.icon && <i class={link.icon}></i>}
										</span>
										<span class="contact-label">{link.label}</span>
									</button>
								) : (
									<a href={link.href} target={link.target} rel={link.rel} class="contact-link">
										<span class={`contact-icon ${link.icon}`}></span>
										<span class="contact-label">{link.label}</span>
									</a>
								)
							))}
						</div>
					</div>
				)}

				{HOME_SECTIONS.projects && PROJECTS.length > 0 && (
					<div class="home-projects scroll-reveal" data-delay="3">
						<div class="projects-header">
							<span class="projects-label">Projects</span>
						</div>
						<div class="projects-grid">
							{PROJECTS.map((project) => (
								<a href={project.url} target="_blank" rel="noopener" class="project-card">
									<img src={project.image} alt={project.imageAlt || project.name} class="project-image" />
									<div class="project-content">
										<div class="project-header">
											<h3 class="project-name">{project.name}</h3>
											<span class="project-arrow">→</span>
										</div>
										<p class="project-desc">{project.description}</p>
									</div>
								</a>
							))}
						</div>
					</div>
				)}

				{HOME_SECTIONS.recentPosts && posts.length > 0 && (
					<div class="home-posts scroll-reveal" data-delay="4">
						<div class="posts-header">
							<span class="posts-label">Recent Posts</span>
							<a href="/blog" class="posts-more">View all →</a>
						</div>
						<div class="posts-list">
							{posts.map((post) => (
								<a href={`/blog/${post.id}/`} class="post-item">
									<div class="post-info">
										<h3 class="post-title">{post.data.title}</h3>
										<p class="post-desc">{post.data.description}</p>
									</div>
									<time class="post-date">
										{post.data.date.toLocaleDateString('en-US', {
											year: 'numeric',
											month: 'short',
											day: 'numeric'
										})}
									</time>
								</a>
							))}
						</div>
					</div>
				)}

				{MODALS.map((modal) => (
					<div class="yuanbao-modal" id={modal.id}>
						<div class="modal-overlay"></div>
						<div class="modal-content">
							<button class="modal-close" id={`${modal.id}Close`}>×</button>
							{modal.brandImg && (
								<div class="modal-brand">
									<img src={modal.brandImg} alt={modal.brandAlt} class="brand-logo" />
								</div>
							)}
							<p class="modal-desc">{modal.description}</p>
							<div class="modal-body">
								<div class="modal-number">
									<span class="number-label">{modal.numberLabel}</span>
									<span class="number-value">{modal.numberValue}</span>
								</div>
								{modal.qrCode && (
									<div class="modal-qrcode">
										<img src={modal.qrCode.img} alt={modal.qrCode.alt} class="qrcode-img" />
										{modal.qrCode.hint && <p class="qrcode-hint">{modal.qrCode.hint}</p>}
									</div>
								)}
							</div>
						</div>
					</div>
				))}

			</div>
		</main>
		<Footer />
		<HomeStyles />
		<ScrollReveal />
	</body>
</html>
